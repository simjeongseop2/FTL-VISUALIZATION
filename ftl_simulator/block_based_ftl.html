<!DOCTYPE html>
<html lang="en" dir="ltr">
  <title>BLOCK FTL VISUALIZATION</title>
  <link href="./images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
  <head>
    <link rel="stylesheet" type="text/css" href="semantic UI/semantic/semantic.css">
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="semantic UI/semantic/semantic.js"></script>
  </head>
  <style>
    table {
        border-collapse: collapse;
        text-align: center;
        line-height: 1.5;
        border-collapse:collapse;
        empty-cells: show | inherit;
        font-size: 18px;
    }
    table th {
      border-bottom:1px solid #CCC;
      width: 50px;
      height: 7.5px;
      color: #fff;
      background: #4B89DC;
      font-size: 16px;
    }
    table td {
      width: 26.25px;
      height: : 7.5px
      border-bottom: 1px solid #ccc;
    }
    body {
      padding: 1rem;
    }
    h1 {
      border-bottom: 1px solid;
    }
    #BMT {
      position: absolute;
    	left : 200px;
    	top : 200px;
    }
    #OPERATION {
      position: absolute;
      left : 1300px;
      top : 200px;
      display: none;
    }
    #BMT_NAME {
      position: absolute;
      left: 110px;
      top: 200px;
      font-size: 20px;
    }
    #BLK_NAME {
      position: absolute;
      left: 410px;
      top: 200px;
      font-size: 20px;
    }
    #Operate {
      position: absolute;
      left : 1300px;
      top : 150px;
      display: none;
    }
    #info {
      position: absolute;
      left: 200px;
      top: 600px;
      font-size: 30px;
      /*color: #FFDC00;*/
    }
    .BLOCK {
      position:absolute;
    	left : 500px;
    	top : 200px;
    }

    .focus {
      /* border:5px solid red; */
      background: #F08080;
    }
    .invalid {
      background: #a28089;
    }
    .valid {
      background: #d0bdf4;
    }

  </style>
  <body id="body">
    <h1>BLOCK Based FTL VISUALIZATION</h1>
    <div class="ui mini input focus placeholder">
    <input type="text" id="LPN_input" placeholder="LPN" />
    </div>
    <div class="ui mini input focus">
    <input type="text" id="DATA_input" placeholder="DATA" />
    </div>
    <input type="button" id="Write" class="ui primary button" value="Write" />
    <div class="ui mini input focus placeholder">
    <input type="text" id="LPN_input2" placeholder="LPN" />
    </div>
     <input type="button" id="Read" class="ui primary button" value="Read" />
    <input type="button" id="play_pause" class="ui button" value="Play" />
    <!-- <div class="ui floating dropdown labeled icon button">
      <div class="text">Delay</div>
      <i class="hourglass icon"></i>
      <div class="menu">
        <div class="item" id = "delay_up">Up</div>
        <div class="item" id = "delay_down">Down</div>
      </div>
    </div> -->
    <button class="ui icon button" id = "delay_up">
      <i class="arrow up icon"></i>
    </button>
    <span>delay: </span>
    <span id = "delay"></span>
    <button class="ui icon button" id = "delay_down">
      <i class="arrow down icon"></i>
    </button>
    <!-- <input type="button" id="delay_up" class="ui button" value="delay_up" />
    <i class="angle up icon"></i>
    <span id = "delay"></span>
    <i class="angle down icon"></i>
    <input type="button" id="delay_down" class="ui button" value="delay_down" /> -->

    <button type="button" id="step_back" class="ui button"><i class="undo icon"></i>Step Back</button>
    <button type="button" id="step_foward" class="ui button"><i class="redo icon"></i>Step Foward</button>

    <button type="button" id="cancle" class="ui button"><i class="trash alternate icon"></i>cancel</button>
    <span id = "Open_file">
      <label for="file" class="ui button"><i class="file icon"></i> Open File</label> 
      <input type="file" accept="text/plain" onchange="openFile(event)" id="file" style="display: none"/> 
       <!-- <input type='file' accept='text/plain' onchange='openFile(event)' value="Open File"> -->
    </span>
    <div class="ui floating dropdown labeled icon button" id="Menu">
      <div class="text">Menu</div>
      <i class="bars icon"></i>
      <div class="menu">
        <div class="item">
          <a href="./main.html">Home</a>
        </div>
        <div class="item">
          <a href="./page_based_ftl.html">Page Based FTL</a>
        </div>
        <div class="item">
          <a href="./sector_based_ftl.html">Sector Based FTL</a>
        </div>
        <div class="item">
          <a href="./hybrid_mapping_ftl.html">Hybrid Mapping FTL</a>
        </div>
        <div class="item">
          <a href="./page_based_ftl.html">DFTL</a>
        </div>
      </div>
    </div>
    <div class="ui floating dropdown labeled icon button" id = "Setting">
      <div class="text">Setting</div>
      <!-- <i class="dropdown icon"></i> -->
      <i class="cog icon"></i>
      <div class="menu">
        <div class="item">
          <div class="item" id = "blk_inc">BLK <i class="arrow alternate circle up icon"></i></div>
        </div>
        <div class="item">
          <div class="item" id = "blk_dec">BLK <i class="arrow alternate circle down icon"></i></div>
        </div>
        <div class="item">
          <div class="item" id = "page_per_blk_inc">Pages per BLK <i class="arrow alternate circle up icon"></i></div>
        </div>
        <div class="item">
          <div class="item" id = "page_per_blk_dec">Pages per BLK <i class="arrow alternate circle down icon"></i></div>
        </div>
      </div>
    </div>
    <input type="button" id="Operate" class="ui primary button" value="Operate" />

    <script>
      function  find_char(str, chr) {
        for(i = 0; i < str.length; i++)
          if(str[i] == chr)
            return true;
        return false;
      }
      var openFile = function(event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function(){
          var text = reader.result;
          // var node = document.getElementById('output');
          // node.innerText = text;
          var res = text.split(/\s+/);
          for(var i = 0; i < res.length; i++)
            console.log(res[i]);
          // console.log(reader.result.substring(0, 200));
          var temp_row = 0;
          OPERATION_ROWS = 0;
          var idx = 0;
          var slot_idx = 0;
          var hyphen_var;
          var comma_var;
          while(idx < res.length) {
            if(res[idx] == 'read') {    
              temp_row += 1;         
              slot_idx += 1;
            } else if(res[idx] == 'write') {
              temp_row += 1;
              slot_idx += 1;
            }
            idx += 1;
          }
          // for(var i = 0; i < temp_row; i++)
          //   OPERATION_add_row();
          $("#OPERATION").css("display", "block");
          $("#Operate").css("display", "block");
          idx = 0;
          slot_idx = 0;
          while(idx < res.length) {
            if(res[idx] == 'read') {
              idx += 1;
              var lpn_isArray = false;
              var lpn_var = res[idx];
              if(find_char(lpn_var, '-') == true) {
                lpn_isArray = true;
                var lpn_temp = res[idx].split('-');
                var lpn_length = Number(lpn_temp[1]) - Number(lpn_temp[0]);
                console.log("lpn_temp[1]: " + lpn_temp[1]);
                console.log("lpn_temp[0]: " + lpn_temp[0]);
                lpn_var = Array();
                for(var i = 0; i <= lpn_length; i++)
                  lpn_var[i] = Number(lpn_temp[0]) + i;
              } else if(find_char(lpn_var, ',') == true) {
                lpn_isArray = true;
                lpn_var = res[idx].split(',')
              }

              if(lpn_isArray) {
                for(var i = 0; i < lpn_var.length; i++) {
                  var lpn_input;
                  if(i >= lpn_var.length)
                    lpn_input = 0;
                  else
                    lpn_input = lpn_var[i];

                  OPERATION_add_row();
                  OPERATION_get_OPERATION(slot_idx).html('READ');
                  OPERATION_get_LPN(slot_idx).html(lpn_input);
                  OPERATION_get_DATA(slot_idx).html('empty');
                  slot_idx += 1;
                  OPERATION_ROWS += 1;
                }
              } else {
                OPERATION_add_row();
                OPERATION_get_OPERATION(slot_idx).html('READ');
                OPERATION_get_LPN(slot_idx).html(lpn_var);
                OPERATION_get_DATA(slot_idx).html('empty');
                slot_idx += 1;
                OPERATION_ROWS += 1;
              }
            } else if(res[idx] == 'write') {
              var lpn_isArray = false;
              var data_isArray = false;
              // OPERATION_get_OPERATION(slot_idx).html('WRITE');
              idx += 1;
              // var temp = res[idx].split('-');
              // console.log(res[idx] + " hypen: " + res[idx].indexOf('-'));
              // console.log(res[idx] + " comma: " + res[idx].indexOf(','));
              var lpn_var = res[idx];
              if(find_char(lpn_var, '-') == true) {
                lpn_isArray = true;
                var lpn_temp = res[idx].split('-');
                var lpn_length = Number(lpn_temp[1]) - Number(lpn_temp[0]);
                console.log("lpn_temp[1]: " + lpn_temp[1]);
                console.log("lpn_temp[0]: " + lpn_temp[0]);
                lpn_var = Array();
                for(var i = 0; i <= lpn_length; i++)
                  lpn_var[i] = Number(lpn_temp[0]) + i;
              } else if(find_char(lpn_var, ',') == true) {
                lpn_isArray = true;
                lpn_var = res[idx].split(',')
              }
              // OPERATION_get_LPN(slot_idx).html(res[idx]);
              idx += 1;
              var data_var = res[idx];
              if(find_char(data_var, '-') == true) {
                data_isArray = true;
                data_temp = res[idx].split('-');
                var data_length = Number(data_temp[1]) - Number(data_temp[0]);
                data_var = Array();
                for(var i = 0; i <= data_length; i++)
                  data_var[i] = Number(data_temp[0]) + i;
              } else if(find_char(data_var, ',')) {
                data_isArray = true;
                data_var = res[idx].split(',');
              }
              // OPERATION_get_DATA(slot_idx).html(res[idx]);
              if(lpn_isArray || data_isArray) {
                for(var i = 0; i < lpn_var.length || i < data_var.length; i++) {
                  var lpn_input;
                  var data_input;
                  if(i >= lpn_var.length)
                    lpn_input = 0;
                  else
                    lpn_input = lpn_var[i];
                  if(i >= data_var.length)
                    data_input = 0;
                  else
                    data_input = data_var[i];

                  OPERATION_add_row();
                  OPERATION_get_OPERATION(slot_idx).html('WRITE');
                  OPERATION_get_LPN(slot_idx).html(lpn_input);
                  OPERATION_get_DATA(slot_idx).html(data_input);
                  slot_idx += 1;
                  OPERATION_ROWS += 1;
                  console.log("isArray OPERATION_ROWS: " + OPERATION_ROWS);
                  console.log("lpn_input: " + lpn_input);
                  console.log("data_input: " + data_input);
                }
              } else {
                OPERATION_add_row();
                OPERATION_get_OPERATION(slot_idx).html('WRITE');
                OPERATION_get_LPN(slot_idx).html(lpn_var);
                OPERATION_get_DATA(slot_idx).html(data_var);
                slot_idx += 1;
                OPERATION_ROWS += 1;
                console.log("NOArray OPERATION_ROWS: " + OPERATION_ROWS);
              }
            }
            idx += 1;
          }
        };
        reader.readAsText(input.files[0]);
      };
    </script>
    <span id = "BMT_NAME" class = name>BMT</span>
    <span id = "BLK_NAME" class = name>BLOCK</span>



    <table id = "BMT">
      <thead id = "BMT_head">
        <th style="border-top-left-radius: 5px;">LBN</th>
        <th style="border-top-right-radius: 5px;">PBN</th>
      </thead>
      <tbody id="BMT-tbody"></tbody>
    </table>
    <table id = "BLK0" class = "BLOCK">
      <thead id = "BLK0_head">
        <th style="border-top-left-radius: 5px;">PPN</th>
        <th>DATA</th>
        <th>LPN</th>
        <th style="border-top-right-radius: 5px;">STATE</th>
      </thead>
      <tbody id="BLK0-tbody"></tbody>
    </table>
    <table id = "OPERATION">
      <thead>
        <th style="border-top-left-radius: 5px;">NUM</th>
        <th>OPER</th>
        <th>LPN</th>
        <th style="border-top-right-radius: 5px;">DATA</th>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      $('.ui.dropdown').dropdown({
        direction: 'downward',
        duration:800,
        onChange: function(value, text, $choice) {
        }
      });
      $.urlParam = function(name){
          var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
          if (results==null){
             return null;
          }
          else{
             return results[1] || 0;
          }
      }
      $("#play_pause").attr('disabled', true);
      var stat_save_arr = new Array();
      var stat_idx = -1;
      var BLKS_PER_BANK = 8;
      if($.urlParam('BLK') != null) {
        BLKS_PER_BANK = Number($.urlParam('BLK'));
      }
      var PAGES_PER_BLK = 5;
      if($.urlParam('BLK_PAGE') != null) {
        PAGES_PER_BLK = Number($.urlParam('BLK_PAGE'));
      }
      var PAGES_PER_BANK = BLKS_PER_BANK * PAGES_PER_BLK;
      var LBNS = (BLKS_PER_BANK - 1);
      var LPNS = PAGES_PER_BLK * LBNS;
      var BMT_numofRAW = 0;
      var numofPAGE = 0;
      var numofBLK = 1;
      var delay = 1500; 
      var timeld = null;
      var OPERATION_numofRAW = 0;
      var OPERATION_ROWS = 5;
      var OPERATION_CNT = 0;

      $("#blk_inc").click(function() {
        if(BLKS_PER_BANK >= 9) {
          alert("MAX BLK NUM");
          return;
        }
        var url = "./block_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK) + 1) + "&BLK_PAGE=" + (PAGES_PER_BLK);
        $(location).attr('href', url);
      });
      $("#blk_dec").click(function() {
        if(BLKS_PER_BANK <= 2) {
          alert("MIN BLK NUM");
          return;
        }
        var url = "./block_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK) - 1) + "&BLK_PAGE=" + (PAGES_PER_BLK);
        $(location).attr('href', url);
      });
      $("#page_per_blk_inc").click(function() {
        if(PAGES_PER_BLK >= 6) {
          alert("MAX PAGE NUM");
          return;
        }
        var url = "./block_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK)) + "&BLK_PAGE=" + (Number(PAGES_PER_BLK) +1);
        $(location).attr('href', url);
      });
       $("#page_per_blk_dec").click(function() {
        if(PAGES_PER_BLK <= 2) {
          alert("MIN PAGE NUM");
          return;
        }
        var url = "./block_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK)) + "&BLK_PAGE=" + (Number(PAGES_PER_BLK) - 1);
        $(location).attr('href', url);
      });

      $('#cancle').click(function() {
        cancle_func();
      });

      $('#delay').html(delay);

      $('#delay_down').click(function() {
        if(delay <= 0) {
          alert("delay can't be under 0");
          return;
        }
        delay -= 100;
        $('#delay').html(delay);
      });

      $('#delay_up').click(function() {
        if(delay >= 3000) {
          alert("delay can't be over 3000");
          return;
        }
        delay += 100;
        $('#delay').html(delay);
      });


      $("#step_back").click( function() {
        step_back_func();
      });
      $("#step_foward").click( function() {
        step_foward_func();
      });

      $("#Write").click( function() {
        var LPN_val = $("#LPN_input").val();
        var DATA_val = $("#DATA_input").val();
        if(LPN_val >= LPNS) {
          alert("Wrong LPN number! (LPN range: 0 ~ " + (LPNS - 1) + ")");
          return;
        }

        $("#LPN_input").val(''); $("#DATA_input").val('');
        $("#play_pause").val('pause').attr('disabled', false);
        $("#Write").attr('disabled', true);
        $("#Read").attr('disabled', true);
        $("#delay_up").attr('disabled', true);
        $("#delay_down").attr('disabled', true);
        $("#step_back").attr('disabled', true);
        $("#step_foward").attr('disabled', true);
        $("#cancle").attr('disabled', true);
        $("#Operate").attr('disabled', true);
        ftl_write(LPN_val, DATA_val);
      });
      $("#Read").click( function() {
        var LPN_val = $("#LPN_input2").val();
        if(LPN_val >= LPNS) {
          alert("Wrong LPN number! (LPN range: 0 ~ " + (LPNS - 1) + ")");
          return;
        }

        $("#LPN_input2").val('');
        $("#play_pause").val('pause').attr('disabled', false);
        $("#Write").attr('disabled', true);
        $("#Read").attr('disabled', true);
        $("#delay_up").attr('disabled', true);
        $("#delay_down").attr('disabled', true);
        $("#step_back").attr('disabled', true);
        $("#step_foward").attr('disabled', true);
        $("#cancle").attr('disabled', true);
        $("#Operate").attr('disabled', true);
        ftl_read(LPN_val, 0);
      });
      $("#Operate").click( function() {
        var oper = OPERATION_get_OPERATION(0).html();
        var LPN_val = OPERATION_get_LPN(0).html();
        var DATA_val = OPERATION_get_DATA(0).html();
        if(LPN_val >= LPNS) {
          alert("Wrong LPN number! (LPN range: 0 ~ " + (LPNS - 1) + ")");
          return;
        }

        $("#play_pause").val('pause').attr('disabled', false);
        $("#Write").attr('disabled', true);
        $("#Operate").attr('disabled', true);
        $("#Read").attr('disabled', true);
        $("#delay_up").attr('disabled', true);
        $("#delay_down").attr('disabled', true);
        $("#step_back").attr('disabled', true);
        $("#step_foward").attr('disabled', true);
        $("#cancle").attr('disabled', true);

        if(oper == 'WRITE')
          ftl_write(LPN_val, DATA_val, 1);
        if(oper == 'READ')
          ftl_read(LPN_val, 1);
      });

      $("#play_pause").click( function() {
        if(timeld == null) {
          animation_func();
          $("#delay_up").attr('disabled', true);
          $("#delay_down").attr('disabled', true);
          $("#step_back").attr('disabled', true);
          $("#step_foward").attr('disabled', true);
          timeld = setInterval(animation_func, delay);
          $(this).val('pause');
        }
        else {
          clearInterval(timeld);
          $(this).val('play');
          $("#delay_up").attr('disabled', false);
          $("#delay_down").attr('disabled', false);
          $("#step_back").attr('disabled', false);
          $("#step_foward").attr('disabled', false);
          timeld = null;
        }
      });


      function ftl_write(lpn, data, oper) {
        var step_info;
        add_stat();
        if(stat_idx > 0)
          copy_stat(stat_idx, stat_idx - 1);

        if(oper == 1) {
          var step_info = alloc_step();
          step_info.motion = 'operation start';
          step_info.info = 'Operate First Line';
        }

        var now_stat = stat_save_arr[stat_idx];
        var lbn = calc_lbn(lpn);
        var offset = calc_offset(lpn);
        var pbn = now_stat.bmt[lbn];
        var replaced = 0;

        console.log("lpn: " + lpn);
        console.log("lbn: " + lbn);
        console.log("offset: " + offset);
        console.log("pbn: " + pbn);

        if(gc_condition_check(lpn, lbn, offset, pbn, data, now_stat)) {
          replaced = garbage_collection(lpn, lbn, offset, pbn, data, now_stat);
          now_stat = stat_save_arr[stat_idx];
          pbn = now_stat.bmt[lbn];
        }

        if(replaced == 0) {
          if(pbn == -1) {
            pbn = get_free_blk_idx(now_stat);
            now_stat.bmt[lbn] = pbn;

            //save animation
            var step_info = alloc_step();
            step_info.motion = 'change pbn';
            step_info.info = 'Change PBN';
            step_info.lbn = lbn;
            step_info.pbn = pbn;
            // BMT_get_PBN(lbn).html(pbn);
          }

          write_data_to_ppn(lpn, data, lbn, pbn, offset, now_stat);
        }
       
        if(oper == 1) {
          step_info = alloc_step();
          step_info.motion = 'operation finish';
          step_info.info = 'Delete First Line';
        }

        animation_func();
        timeld = setInterval(animation_func, delay);
      }
      function ftl_read(lpn, oper) {
        var step_info;
        add_stat();
        if(stat_idx > 0)
          copy_stat(stat_idx, stat_idx - 1);

        if(oper == 1) {
          var step_info = alloc_step();
          step_info.motion = 'operation start';
          step_info.info = 'Operate First Line';
        }

        var now_stat = stat_save_arr[stat_idx];
        var lbn = calc_lbn(lpn);
        var offset = calc_offset(lpn);
        var pbn = now_stat.bmt[lbn];
        var replaced = 0;

        //save animation
        var step_info = alloc_step();
        step_info.motion = 'change pbn';
        step_info.info = 'Check PBN';
        step_info.lbn = lbn;
        step_info.pbn = pbn;
        if(pbn == -1) {
          step_info.info += ': none';
          step_info.pbn = 'none';
        } else {
          var page_num = pbn * PAGES_PER_BLK + offset;
          step_info = alloc_step();
          step_info.motion = 'read page';
          step_info.info = 'Read Page Data: ';
          step_info.lpn = lpn;
          step_info.data = now_stat.page_data[page_num];
          step_info.lbn = lbn;
          step_info.pbn = pbn;
          step_info.page_num = page_num;
          if(now_stat.page_stat[page_num] == 'invalid') {
            step_info.info += 'Invalid';
            step_info.motion = 'make invalid';

          }
          else if(now_stat.page_stat[page_num] == 'empty') {
            step_info.info += 'Empty';
            step_info.motion = 'make empty';
          }
          else {
            step_info.info += now_stat.page_data[page_num];
            step_info.motion = 'write page';
          }
        }
        if(oper == 1) {
          step_info = alloc_step();
          step_info.motion = 'operation finish';
          step_info.info = 'Delete First Line';
        }

        animation_func();
        timeld = setInterval(animation_func, delay);
      }

      function get_free_blk_idx(now_stat) {
        for(var i = 0; i < BLKS_PER_BANK; i++) {
          if(now_stat.free_blk_idx != i) {
            for(var j = 0; j < PAGES_PER_BLK; j++) {
              var page_num = i * PAGES_PER_BLK + j;
              if(now_stat.page_stat[page_num] != 'empty')
                break;
              if(page_num - i * PAGES_PER_BLK == PAGES_PER_BLK - 1)
                return i;
            }
          }
        }
        return -2; //something wrong
      }

      function calc_lbn(lpn) {
        return parseInt(lpn / PAGES_PER_BLK);
      }
      function calc_offset(lpn) {
        return lpn % PAGES_PER_BLK;
      }
      function write_data_to_ppn(lpn, data, lbn, pbn, offset, now_stat) {
        var step_info;
        for(var i = 0; i < offset; i++) {
          var page_num = pbn * PAGES_PER_BLK + i;
          if(now_stat.page_stat[page_num] == 'empty') {
            console.log("empty page_num: " + page_num);
            now_stat.page_stat[page_num] = 'invalid';
            now_stat.page_spare[page_num] = lpn - offset + i;

            step_info = alloc_step();
            step_info.motion = 'make invalid';
            step_info.info = 'Make Invalid';
            step_info.page_num = page_num;
            step_info.lpn = lpn - offset + i;
            // BLK_get_STATE(page_num).html('invalid');
          }
        }
        var page_num = pbn * PAGES_PER_BLK + offset;
        now_stat.page_stat[page_num] = 'valid';
        now_stat.page_data[page_num] = data;
        now_stat.page_spare[page_num] = lpn;

        step_info = alloc_step();
        step_info.motion = 'write page';
        step_info.info = 'Write Page';
        step_info.page_num = page_num;
        step_info.data = data;
        step_info.lpn = lpn;

        // BLK_get_STATE(page_num).html('valid');
        // BLK_get_DATA(page_num).html(data);
        // BLK_get_LPN(page_num).html(lpn);
      }

      function gc_condition_check(lpn, lbn, offset, pbn, data, now_stat) {
        if(pbn == -1)
          return false;
        var page_num = pbn * PAGES_PER_BLK + offset;
        var blk_num = page_num / PAGES_PER_BLK;
        console.log("page_num: " + page_num);
        console.log("blk_num: " + blk_num);
        console.log("now_stat.page_stat: " + now_stat.page_stat[page_num]);
        console.log("free_blk_idx: " + now_stat.free_blk_idx);
        if(page_num >= PAGES_PER_BANK || now_stat.page_stat[page_num] != 'empty' || blk_num == now_stat.free_blk_idx)
          return true;
        return false;
      }

      function garbage_collection(lpn, lbn, offset, pbn, data, now_stat) {
        var fbn = now_stat.free_blk_idx;  //free block number
        var victim_page_start = pbn * PAGES_PER_BLK;
        var free_page_start = fbn * PAGES_PER_BLK;
        var replaced = 0;

        console.log("<<<garbage_collection called>>>");
        for(var i = 0; i < PAGES_PER_BLK; i++) {
          var page_num = victim_page_start + i;
          var free_page_num = free_page_start + i;

          if(now_stat.page_spare[page_num] == lpn) {
            replaced = 1;
            now_stat.page_stat[free_page_num] = 'valid';
            now_stat.page_data[free_page_num] = data;
            now_stat.page_spare[free_page_num] = now_stat.page_spare[page_num];

            step_info = alloc_step();
            step_info.motion = 'replace page';
            step_info.info = 'Write New page';
            step_info.page_num = free_page_num;
            step_info.data = data;
            step_info.lpn = lpn;
          }
          else {
            if(now_stat.page_stat[page_num] == 'valid') {
              now_stat.page_stat[free_page_num] = 'valid';
              now_stat.page_data[free_page_num] = now_stat.page_data[page_num];
              now_stat.page_spare[free_page_num] = now_stat.page_spare[page_num];

              step_info = alloc_step();
              step_info.motion = 'write page';
              step_info.info = 'Move Page';
              step_info.page_num = free_page_num;
              step_info.data = now_stat.page_data[page_num];
              step_info.lpn = now_stat.page_spare[page_num];
              // BLK_get_STATE(free_page_num).html('valid');
              // BLK_get_DATA(free_page_num).html(now_stat.page_data[page_num]);
              // BLK_get_LPN(free_page_num).html(now_stat.page_spare[page_num]);
            } else if(now_stat.page_stat[page_num] == 'invalid') {
              now_stat.page_stat[free_page_num] = 'invalid';
              now_stat.page_spare[free_page_num] = now_stat.page_spare[page_num];

              step_info = alloc_step();
              step_info.motion = 'make invalid';
              step_info.info = 'Make Invalid Page';
              step_info.page_num = free_page_num;
              step_info.lpn = now_stat.page_spare[page_num];
              // BLK_get_STATE(free_page_num).html('invalid');      
            } else {  //empty
              break;
            }
          }

          now_stat.page_stat[page_num] = 'empty';
          now_stat.page_data[page_num] = '';
          now_stat.page_spare[page_num] = '';

          step_info = alloc_step();
          step_info.motion = 'make empty';
          step_info.info = 'Empty Page';
          step_info.page_num = page_num;
          // BLK_get_STATE(page_num).html('empty');
          // BLK_get_DATA(page_num).html('');
          // BLK_get_LPN(page_num).html('');          
        }

        now_stat.bmt[lbn] = fbn;
        now_stat.free_blk_idx = pbn;

        step_info = alloc_step();
        step_info.motion = 'change pbn';
        step_info.info = 'Change PBN';
        step_info.lbn = lbn;
        step_info.pbn = fbn;
        // BMT_get_PBN(lbn).html(fbn);

        return replaced;
      }

      function cancle_func() {
        if(stat_idx == -1) {
          alert("initial state!");
          return;
        }
        $("#BMT").remove();
        for(var i = 0; i < numofBLK; i++) {
          $("#BLK" + i).remove();
        }
        $("#OPERATION").remove();
        OPERATION_CNT -= 1;
        // stat_save_arr[stat_idx].step_idx = stat_save_arr[stat_idx].step_idx - 1;
        var step_info = stat_save_arr[stat_idx].step_arr[0]; // state of right before
        stat_idx -= 1;
        step_info.BMT_elem.appendTo("#body");
        step_info.OPERATION_elem.appendTo("#body");
        if(step_info.file_opened == 1) {
          $("#Operate").css("display", "block");
          console.log("cancle_func OPERATION_ROWS: " + step_info.OPERATION_ROWS);
          OPERATION_ROWS = step_info.OPERATION_ROWS;
        } else {
          $("#Operate").css("display", "none");
        }
        for(var i = 0; i < numofBLK; i++)
          step_info.BLK_elem_arr[i].appendTo("#body");
      }

      function step_back_func() {
        if(stat_save_arr[stat_idx].step_idx == 0) {
          alert("initial state!");
          return;
        }
        $("#BMT").remove();
        $("#OPERATION").remove();
        for(var i = 0; i < numofBLK; i++) {
          $("#BLK" + i).remove();
        }
        stat_save_arr[stat_idx].step_idx = stat_save_arr[stat_idx].step_idx - 1;
        var step_info = stat_save_arr[stat_idx].step_arr[stat_save_arr[stat_idx].step_idx];
        step_info.BMT_elem.appendTo("#body");
        step_info.OPERATION_elem.appendTo("#body");
        for(var i = 0; i < numofBLK; i++)
          step_info.BLK_elem_arr[i].appendTo("#body");
      }
      function step_foward_func() {
        if(stat_save_arr[stat_idx].step_idx == stat_save_arr[stat_idx].step_len) {
          alert("last state!")
          return;
        }
        animation_func();
      }

      function save_step_stat(step_info) {
        step_info.BMT_elem = $("#BMT").clone();
        step_info.OPERATION_elem = $("#OPERATION").clone();
        step_info.BLK_elem_arr = new Array();
        for(var i = 0; i < numofBLK; i++) {
          step_info.BLK_elem_arr[i] = $("#BLK" + i).clone();
        }
      }

      function alloc_step() {
        var now_stat = stat_save_arr[stat_idx];
        now_stat.step_arr[now_stat.step_len] = new Object();
        now_stat.step_len++;
        return now_stat.step_arr[now_stat.step_len - 1];
      }

      function animation_func() {
        if(stat_save_arr[stat_idx].step_idx >= stat_save_arr[stat_idx].step_len) {
          clearInterval(timeld);
          timeld = null;
          $("#play_pause").val('play').attr('disabled', true);
          $("#Write").attr('disabled', false);
          $("#Operate").attr('disabled', false);
          $("#Read").attr('disabled', false);
          $("#delay_up").attr('disabled', false);
          $("#delay_down").attr('disabled', false);
          $("#step_back").attr('disabled', false);
          $("#step_foward").attr('disabled', false);
          $("#cancle").attr('disabled', false);
          return;
        }

        var step_info = stat_save_arr[stat_idx].step_arr[stat_save_arr[stat_idx].step_idx];
        stat_save_arr[stat_idx].step_idx++;

        console.log("motion: " + step_info.motion);
        $('body').append('<span id = "info">' + step_info.info + '</span>');
        setTimeout(function() {
          $("#info").remove();
        }, delay);

        if(step_info.motion == 'change pbn') {
          save_step_stat(step_info);
          BMT_get_PBN(step_info.lbn).addClass('focus');
          setTimeout(function() {
            BMT_get_PBN(step_info.lbn).removeClass('focus').html(step_info.pbn);
          }, delay / 2);
        } else if(step_info.motion == 'make invalid') {
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page_num).removeClass('valid').removeClass('invalid').addClass('focus');
          BLK_get_STATE(step_info.page_num).removeClass('valid').removeClass('invalid').addClass('focus');
          BLK_get_LPN(step_info.page_num).removeClass('valid').removeClass('invalid').addClass('focus');
          BLK_get_DATA(step_info.page_num).removeClass('valid').removeClass('invalid').addClass('focus');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page_num).removeClass('focus').addClass('invalid');
            BLK_get_STATE(step_info.page_num).removeClass('focus').addClass('invalid').html('invalid');
            BLK_get_LPN(step_info.page_num).removeClass('focus').addClass('invalid').html(step_info.lpn);
            BLK_get_DATA(step_info.page_num).removeClass('focus').addClass('invalid').html('none');
          }, delay / 2);
        } else if(step_info.motion == 'make empty') {
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page_num).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_STATE(step_info.page_num).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_DATA(step_info.page_num).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_LPN(step_info.page_num).removeClass('invalid').removeClass('valid').addClass('focus');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page_num).removeClass('focus');
            BLK_get_STATE(step_info.page_num).removeClass('focus').html('empty');
            BLK_get_DATA(step_info.page_num).removeClass('focus').html('');
            BLK_get_LPN(step_info.page_num).removeClass('focus').html('');
          }, delay / 2);
        } else if(step_info.motion == 'write page') {
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page_num).addClass('focus').removeClass('valid');
          BLK_get_STATE(step_info.page_num).addClass('focus').removeClass('valid');
          BLK_get_DATA(step_info.page_num).addClass('focus').removeClass('valid');
          BLK_get_LPN(step_info.page_num).addClass('focus').removeClass('valid');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page_num).removeClass('focus').addClass('valid');
            BLK_get_STATE(step_info.page_num).removeClass('focus').addClass('valid').html('valid');
            BLK_get_DATA(step_info.page_num).removeClass('focus').addClass('valid').html(step_info.data);
            BLK_get_LPN(step_info.page_num).removeClass('focus').addClass('valid').html(step_info.lpn);
          }, delay / 2);
        } else if(step_info.motion == 'replace page') {
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page_num).addClass('focus');
          BLK_get_STATE(step_info.page_num).addClass('focus');
          BLK_get_DATA(step_info.page_num).addClass('focus');
          BLK_get_LPN(step_info.page_num).addClass('focus');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page_num).removeClass('focus').addClass('valid');
            BLK_get_STATE(step_info.page_num).removeClass('focus').addClass('valid').html('valid');
            BLK_get_DATA(step_info.page_num).removeClass('focus').addClass('valid').html(step_info.data);
            BLK_get_LPN(step_info.page_num).removeClass('focus').addClass('valid').html(step_info.lpn);
          }, delay / 2);
        }
        else if(step_info.motion == 'operation start') {
          step_info.file_opened = true;
          step_info.OPERATION_ROWS = OPERATION_ROWS;
          save_step_stat(step_info);
          OPERATION_get_NUM(0).addClass('focus');
          OPERATION_get_OPERATION(0).addClass('focus');
          OPERATION_get_LPN(0).addClass('focus');
          OPERATION_get_DATA(0).addClass('focus');
        } else if(step_info.motion == 'operation finish') {
          step_info.file_opened = false;
          step_info.OPERATION_ROWS = OPERATION_ROWS;
          save_step_stat(step_info);
          $("#OPERATION").addClass('focus');
          // for(var i = 1; i < OPERATION_ROWS; i++) {
          //   OPERATION_get_OPERATION(i).addClass('focus');
          //   OPERATION_get_LPN(i).addClass('focus');
          //   OPERATION_get_DATA(i).addClass('focus');
          // }
          setTimeout(function() {
            $("#OPERATION").removeClass('focus');
            OPERATION_get_NUM(0).removeClass('focus');
            OPERATION_get_OPERATION(0).removeClass('focus');
            OPERATION_get_LPN(0).removeClass('focus');
            OPERATION_get_DATA(0).removeClass('focus');
            for(var i = 0; i < OPERATION_ROWS; i++) {
              // OPERATION_get_OPERATION(i).removeClass('focus');
              // OPERATION_get_LPN(i).removeClass('focus');
              // OPERATION_get_DATA(i).removeClass('focus');
              if(i != 0) {
                var op = OPERATION_get_OPERATION(i).html();
                var lpn = OPERATION_get_LPN(i).html();
                var data = OPERATION_get_DATA(i).html();
                OPERATION_get_OPERATION(i - 1).html(op);
                OPERATION_get_LPN(i - 1).html(lpn);
                OPERATION_get_DATA(i - 1).html(data);
              }
              if(i == OPERATION_ROWS - 1) {
                OPERATION_get_OPERATION(i).html('');
                OPERATION_get_LPN(i).html('');
                OPERATION_get_DATA(i).html('');
              }
            }
          }, delay / 2);
          OPERATION_CNT += 1;
          if(OPERATION_CNT == OPERATION_ROWS) {
            $("#OPERATION").css("display", "none");
            $("#Operate").css("display", "none");
          }
        }
        else {
          console.log("No motion info!");
        }
      }
      
      //start from here
      function add_stat() {
        stat_idx++;
        stat_save_arr[stat_idx] = new Object();
        stat_save_arr[stat_idx].bmt = new Array();
        stat_save_arr[stat_idx].page_stat = new Array();
        stat_save_arr[stat_idx].page_data = new Array();
        stat_save_arr[stat_idx].page_spare = new Array();
        stat_save_arr[stat_idx].page_to_write = 0;

        stat_save_arr[stat_idx].free_blk_idx = BLKS_PER_BANK - 1;
        if(stat_idx > 1) {
          stat_save_arr[stat_idx].free_blk_idx = stat_save_arr[stat_idx - 1].free_blk_idx;
        }


        for(var i = 0; i < PAGES_PER_BANK; i++) {
          stat_save_arr[stat_idx].bmt[i] = -1;
          stat_save_arr[stat_idx].page_stat[i] = 'empty';
          stat_save_arr[stat_idx].page_data[i] = -1;
          stat_save_arr[stat_idx].page_spare[i] = -1;
        }

        stat_save_arr[stat_idx].step_len = 0;
        stat_save_arr[stat_idx].step_arr = new Array();
        stat_save_arr[stat_idx].step_idx = 0;
      }

      function copy_stat(des, src) {
        // if(stat_idx <= 1) return;
        stat_save_arr[des].page_to_write = stat_save_arr[src].page_to_write;
        stat_save_arr[des].free_blk_idx = stat_save_arr[src].free_blk_idx;
        for(var i = 0; i < PAGES_PER_BANK; i++) {
          stat_save_arr[des].bmt[i] = stat_save_arr[src].bmt[i];
          stat_save_arr[des].page_stat[i] = stat_save_arr[src].page_stat[i];
          stat_save_arr[des].page_data[i] = stat_save_arr[src].page_data[i];
          stat_save_arr[des].page_spare[i] = stat_save_arr[src].page_spare[i];
        }
      }
      for(var i = 0; i < LBNS; i++)
        BMT_add_row();
      for(var i = 0; i < PAGES_PER_BLK; i++)
        BLK_add_row(0);
      for(var i = 0; i < BLKS_PER_BANK - 1; i++)
        BLK_increase();

      function BMT_add_row() {
        $("#BMT").append('<tr id = "BMT_row' + BMT_numofRAW +  '"><tr>');
        for(var i = 0; i < 2; i++) {
          if(i == 0)
            $("#BMT_row"+BMT_numofRAW).append('<td style="border-left: 2px solid #CCC;">' + BMT_numofRAW + '</td>');
          else
            $("#BMT_row"+BMT_numofRAW).append('<td style="border-right: 2px solid #CCC;">none</td>');
        }
        $("#BMT_row" + BMT_numofRAW).css("border-bottom", "1px solid #CCC");
        if(BMT_numofRAW == LPNS - 1) {
          $("#BMT_row" + BMT_numofRAW).css("border-bottom", "2px solid #CCC").css("border-bottom-left-radius", "5px");
        }
        BMT_numofRAW++;
      }
      function OPERATION_add_row() {
        $("#OPERATION").append('<tr id = "OPERATION_row' + OPERATION_numofRAW +  '"><tr>');
        for(var i = 0; i < 4; i++) {
          if(i == 0)
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td style="border-left: 2px solid #CCC;">' + (OPERATION_numofRAW + 1) + '</td>');
          else if(i == 1)
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td></td>');
          else if(i == 3)
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td style="border-right: 2px solid #CCC;"></td>');
          else
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td></td>');
        }
        if(OPERATION_numofRAW == OPERATION_ROWS - 1) 
          $("#OPERATION_row"+OPERATION_numofRAW).css("border-bottom", "2px solid #CCC");
        else
          $("#OPERATION_row"+OPERATION_numofRAW).css("border-bottom", "1px solid #CCC"); 
        OPERATION_numofRAW++;
      }
      function BLK_add_row(blk_idx) {
        $("#BLK" + blk_idx).append('<tr id = "page_row' + numofPAGE +  '"><tr>');
        for(var i = 0; i < 4; i++) {
          if(i == 0) {
            $("#page_row"+numofPAGE).append('<td style="border-left: 2px solid #CCC;">' + numofPAGE + '</td>');
          }
          else if (i == 3) {
            $("#page_row"+numofPAGE).append('<td style="border-right: 2px solid #CCC;">empty</td>');
          }
          else {
            $("#page_row"+numofPAGE).append('<td></td>');
          }
        }
        $("#page_row"+numofPAGE).css("border-bottom", "1px solid #CCC");
        if(numofPAGE == PAGES_PER_BLK - 1) {
          $("#page_row"+numofPAGE).css("border-bottom", "2px solid #CCC");
        }
        numofPAGE++;
      }
      function BLK_increase() {
        var origin = "#BLK" + (numofBLK - 1);
        var temp = $(origin).clone();
        
        if(numofBLK < 3) {
          temp.appendTo("#body").offset({left: $(origin).offset().left + 260, top: $(origin).offset().top});
        } else {
          var side = "#BLK" + (numofBLK - 3);
          temp.appendTo("#body").offset({left: $(side).offset().left, top: $(side).offset().top + 220});
        }
        temp.attr("id", "BLK" + (numofBLK));
        temp.attr("class", "BLOCK");

        numofBLK++;
        for(var i = 0; i < PAGES_PER_BLK; i++) {
          BLK_set_PPN_data(numofPAGE, numofPAGE);
          numofPAGE++;
        }
      }

      function BLK_get_PPN_data(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 0 +')');
      }
      function BLK_get_DATA(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 1 +')');
      }
      function BLK_get_LPN(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 2 +')');
      }
      function BLK_get_STATE(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 3 +')');
      }
      function BLK_set_PPN_data(page_num, data) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 0 +')').html(data);
      }
      function BMT_get_LBN(slot_idx) {
        return $('#BMT tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 0 +')');
      }
      function BMT_get_PBN(slot_idx) {
        return $('#BMT tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 1 +')');
      }
      function OPERATION_get_NUM(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 0 +')');
      }
      function OPERATION_get_OPERATION(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 1 +')');
      }
      function OPERATION_get_LPN(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 2 +')');
      }
      function OPERATION_get_DATA(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 3 +')');
      }
    </script>
  </body>
</html>
