<!doctype html>
<html>
  <head>
    <title>SECTOR FTL VISUALIZATION</title>
    <link href="./images/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="semantic UI/semantic/semantic.css">
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
    <script src="semantic UI/semantic/semantic.js"></script>
  </head>
  <style>
    table {
        border-collapse: collapse;
        text-align: center;
        line-height: 1.5;
        empty-cells: show | inherit;
        font-size: 18px;
    }
    table th {
      /*border:1px solid #CCC;*/
      width: 70px;
      height: : 7.5px;
      border-bottom: 1px solid #CCC;
      background: #4B89DC;
      color: #fff;
      font-size: 16px;
      /*font-weight: bold;*/
    }
    table td {
      /*border:1px solid #CCC;*/
      width: 26.25px;
      height: : 7.5px
      border-bottom: 1px solid #CCC;
    }
    body {
      padding: 1rem;
      /*background-image: linear-gradient(to top right, #93a5cf, #e4efe9);*/
    }
    h1 {
      border-bottom: 1px solid;
    }
    #PMT {
      position: absolute;
    	left : 200px;
    	top : 180px;
    }
     #OPERATION {
      position: absolute;
      left : 1500px;
      top : 180px;
      display: none;
    }
    #PMT_NAME {
      position: absolute;
      left: 110px;
      top: 180px;
      font-size: 20px;
    }
    #RAM_NAME {
      position: absolute;
      left: 110px;
      top: 650px;
      font-size: 20px;
    }
    #BLK_NAME {
      position: absolute;
      left: 410px;
      top: 180px;
      font-size: 20px;
    }
    #Operate {
      position: absolute;
      left : 1500px;
      top : 140px;
      display: none;
    }
    #RAM {
      position: absolute;
      left : 200px;
      top : 650px;
    }
    #info {
      position: absolute;
      left: 600px;
      top: 570px;
      font-size: 30px;
      /*color: #FFDC00;*/
    }
    .BLOCK {
      position:absolute;
    	left : 500px;
    	top : 180px;
    }
   
    .focus {
      /* border:5px solid red; */
      background: #F08080;
    }
    .invalid {
      background: #a28089;
    }
    .valid {
      background: #d0bdf4;
    }
  </style>
  <body id="body"> 
    <h1>SECTOR Based FTL VISUALIZATION</h1>

    <div class="ui mini input focus placeholder">
    <input type="text" id="LPN_input" placeholder="LPN" />
    </div>
    <div class="ui mini input focus">
    <input type="text" id="DATA_input" placeholder="DATA" />
    </div>
    <input type="button" id="Write" class="ui primary button" value="Write" />
    <div class="ui mini input focus placeholder">
    <input type="text" id="LPN_input2" placeholder="LPN" />
    </div>
     <input type="button" id="Read" class="ui primary button" value="Read" />
    <input type="button" id="play_pause" class="ui button" value="Play" />
    <!-- <div class="ui floating dropdown labeled icon button">
      <div class="text">Delay</div>
      <i class="hourglass icon"></i>
      <div class="menu">
        <div class="item" id = "delay_up">Up</div>
        <div class="item" id = "delay_down">Down</div>
      </div>
    </div> -->
    <button class="ui icon button" id = "delay_up">
      <i class="arrow up icon"></i>
    </button>
    <span>delay: </span>
    <span id = "delay"></span>
    <button class="ui icon button" id = "delay_down">
      <i class="arrow down icon"></i>
    </button>
    <!-- <input type="button" id="delay_up" class="ui button" value="delay_up" />
    <i class="angle up icon"></i>
    <span id = "delay"></span>
    <i class="angle down icon"></i>
    <input type="button" id="delay_down" class="ui button" value="delay_down" /> -->

    <button type="button" id="step_back" class="ui button"><i class="undo icon"></i>Step Back</button>
    <button type="button" id="step_foward" class="ui button"><i class="redo icon"></i>Step Foward</button>

    <button type="button" id="cancle" class="ui button"><i class="trash alternate icon"></i>cancel</button>
    <span id = "Open_file">
      <label for="file" class="ui button"><i class="file icon"></i> Open File</label> 
      <input type="file" accept="text/plain" onchange="openFile(event)" id="file" style="display: none"/> 
       <!-- <input type='file' accept='text/plain' onchange='openFile(event)' value="Open File"> -->
    </span>
    <div class="ui floating dropdown labeled icon button" id="Menu">
      <div class="text">Menu</div>
      <i class="bars icon"></i>
      <div class="menu">
        <div class="item">
          <a href="./main.html">Home</a>
        </div>
        <div class="item">
          <a href="./page_based_ftl.html">Page Based FTL</a>
        </div>
        <div class="item">
          <a href="./block_based_ftl.html">Block Based FTL</a>
        </div>
        <div class="item">
          <a href="./hybrid_mapping_ftl.html">Hybrid Mapping FTL</a>
        </div>
        <div class="item">
          <a href="./page_based_ftl.html">DFTL</a>
        </div>
      </div>
    </div>
    <div class="ui floating dropdown labeled icon button" id = "Setting">
      <div class="text">Setting</div>
      <!-- <i class="dropdown icon"></i> -->
      <i class="cog icon"></i>
      <div class="menu">
        <div class="item">
          <div class="item" id = "blk_inc">BLK <i class="arrow alternate circle up icon"></i></div>
        </div>
        <div class="item">
          <div class="item" id = "blk_dec">BLK <i class="arrow alternate circle down icon"></i></div>
        </div>
        <div class="item">
          <div class="item" id = "page_per_blk_inc">Pages per BLK <i class="arrow alternate circle up icon"></i></div>
        </div>
        <div class="item">
          <div class="item" id = "page_per_blk_dec">Pages per BLK <i class="arrow alternate circle down icon"></i></div>
        </div>
      </div>
    </div>
    <input type="button" id="Operate" class="ui primary button" value="Operate" />

    <script>
      function  find_char(str, chr) {
        for(i = 0; i < str.length; i++)
          if(str[i] == chr)
            return true;
        return false;
      }
      var openFile = function(event) {
        var input = event.target;

        var reader = new FileReader();
        reader.onload = function(){
          var text = reader.result;
          // var node = document.getElementById('output');
          // node.innerText = text;
          var res = text.split(/\s+/);
          for(var i = 0; i < res.length; i++)
            console.log(res[i]);
          // console.log(reader.result.substring(0, 200));
          var temp_row = 0;
          OPERATION_ROWS = 0;
          var idx = 0;
          var slot_idx = 0;
          var hyphen_var;
          var comma_var;
          while(idx < res.length) {
            if(res[idx] == 'read') {    
              temp_row += 1;         
              slot_idx += 1;
            } else if(res[idx] == 'write') {
              temp_row += 1;
              slot_idx += 1;
            }
            idx += 1;
          }
          // for(var i = 0; i < temp_row; i++)
          //   OPERATION_add_row();
          $("#OPERATION").css("display", "block");
          $("#Operate").css("display", "block");
          idx = 0;
          slot_idx = 0;
          while(idx < res.length) {
            if(res[idx] == 'read') {
              idx += 1;
              var lpn_isArray = false;
              var lpn_var = res[idx];
              if(find_char(lpn_var, '-') == true) {
                lpn_isArray = true;
                var lpn_temp = res[idx].split('-');
                var lpn_length = Number(lpn_temp[1]) - Number(lpn_temp[0]);
                console.log("lpn_temp[1]: " + lpn_temp[1]);
                console.log("lpn_temp[0]: " + lpn_temp[0]);
                lpn_var = Array();
                for(var i = 0; i <= lpn_length; i++)
                  lpn_var[i] = Number(lpn_temp[0]) + i;
              } else if(find_char(lpn_var, ',') == true) {
                lpn_isArray = true;
                lpn_var = res[idx].split(',')
              }

              if(lpn_isArray) {
                for(var i = 0; i < lpn_var.length; i++) {
                  var lpn_input;
                  if(i >= lpn_var.length)
                    lpn_input = 0;
                  else
                    lpn_input = lpn_var[i];

                  OPERATION_add_row();
                  OPERATION_get_OPERATION(slot_idx).html('READ');
                  OPERATION_get_LPN(slot_idx).html(lpn_input);
                  OPERATION_get_DATA(slot_idx).html('empty');
                  slot_idx += 1;
                  OPERATION_ROWS += 1;
                }
              } else {
                OPERATION_add_row();
                OPERATION_get_OPERATION(slot_idx).html('READ');
                OPERATION_get_LPN(slot_idx).html(lpn_var);
                OPERATION_get_DATA(slot_idx).html('empty');
                slot_idx += 1;
                OPERATION_ROWS += 1;
              }              
            } else if(res[idx] == 'write') {
              var lpn_isArray = false;
              var data_isArray = false;
              // OPERATION_get_OPERATION(slot_idx).html('WRITE');
              idx += 1;
              // var temp = res[idx].split('-');
              // console.log(res[idx] + " hypen: " + res[idx].indexOf('-'));
              // console.log(res[idx] + " comma: " + res[idx].indexOf(','));
              var lpn_var = res[idx];
              if(find_char(lpn_var, '-') == true) {
                lpn_isArray = true;
                var lpn_temp = res[idx].split('-');
                var lpn_length = Number(lpn_temp[1]) - Number(lpn_temp[0]);
                console.log("lpn_temp[1]: " + lpn_temp[1]);
                console.log("lpn_temp[0]: " + lpn_temp[0]);
                lpn_var = Array();
                for(var i = 0; i <= lpn_length; i++)
                  lpn_var[i] = Number(lpn_temp[0]) + i;
              } else if(find_char(lpn_var, ',') == true) {
                lpn_isArray = true;
                lpn_var = res[idx].split(',')
              }
              // OPERATION_get_LPN(slot_idx).html(res[idx]);
              idx += 1;
              var data_var = res[idx];
              if(find_char(data_var, '-') == true) {
                data_isArray = true;
                data_temp = res[idx].split('-');
                var data_length = Number(data_temp[1]) - Number(data_temp[0]);
                data_var = Array();
                for(var i = 0; i <= data_length; i++)
                  data_var[i] = Number(data_temp[0]) + i;
              } else if(find_char(data_var, ',')) {
                data_isArray = true;
                data_var = res[idx].split(',');
              }
              // OPERATION_get_DATA(slot_idx).html(res[idx]);
              if(lpn_isArray || data_isArray) {
                for(var i = 0; i < lpn_var.length || i < data_var.length; i++) {
                  var lpn_input;
                  var data_input;
                  if(i >= lpn_var.length)
                    lpn_input = 0;
                  else
                    lpn_input = lpn_var[i];
                  if(i >= data_var.length)
                    data_input = 0;
                  else
                    data_input = data_var[i];

                  OPERATION_add_row();
                  OPERATION_get_OPERATION(slot_idx).html('WRITE');
                  OPERATION_get_LPN(slot_idx).html(lpn_input);
                  OPERATION_get_DATA(slot_idx).html(data_input);
                  slot_idx += 1;
                  OPERATION_ROWS += 1;
                  console.log("isArray OPERATION_ROWS: " + OPERATION_ROWS);
                  console.log("lpn_input: " + lpn_input);
                  console.log("data_input: " + data_input);
                }
              } else {
                OPERATION_add_row();
                OPERATION_get_OPERATION(slot_idx).html('WRITE');
                OPERATION_get_LPN(slot_idx).html(lpn_var);
                OPERATION_get_DATA(slot_idx).html(data_var);
                slot_idx += 1;
                OPERATION_ROWS += 1;
                console.log("NOArray OPERATION_ROWS: " + OPERATION_ROWS);
              }
            }
            idx += 1;
          }
        };
        reader.readAsText(input.files[0]);
      };
    </script>
    <span id = "PMT_NAME" class = name>PMT</span>
    <span id = "RAM_NAME" class = name>RAM</span>
    <span id = "BLK_NAME" class = name>BLOCK</span>

    <table id = "PMT">
      <thead id = "PMT_head">
        <th style="border-top-left-radius: 5px;">LPN</th>
        <th style="border-top-right-radius: 5px;">PPN</th>
      </thead>
      <tbody id="PMT-tbody"></tbody>
    </table>
    <table id = "OPERATION">
      <thead>
        <th style="border-top-left-radius: 5px;">NUM</th>
        <th>OPER</th>
        <th>LPN</th>
        <th style="border-top-right-radius: 5px;">DATA</th>
      </thead>
      <tbody></tbody>
    </table>
    <table id = "BLK0" class = "BLOCK">
      <thead id = "BLK0_head">
        <th style="border-top-left-radius: 5px;">PPN</th>
        <th>DATA1</th>
        <th>DATA2</th>
        <th>DATA3</th>
        <th>LPN</th>
        <th style="border-top-right-radius: 5px;">STATE</th>
      </thead>
      <tbody id="BLK0-tbody"></tbody>
    </table>
    <table id = "RAM">
      <thead id = "RAM_head">
        <th style="border-top-left-radius: 5px;">PPN</th>
        <th>DATA1</th>
        <th>DATA2</th>
        <th>DATA3</th>
        <th style="border-top-right-radius: 5px;">LPN</th>        
      </thead>
      <tbody id="RAM-tbody"></tbody>
    </table>

<!--     <script type="text/javascript" src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.20/jquery-ui.min.js"></script> -->
    <script>
      $('.ui.dropdown').dropdown({
        direction: 'downward',
        duration:800,
        onChange: function(value, text, $choice) {
        }
      });
      $.urlParam = function(name){
          var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
          if (results==null){
             return null;
          }
          else{
             return results[1] || 0;
          }
      }
      $("#play_pause").attr('disabled', true);
      var stat_save_arr = new Array();
      var stat_idx = -1;
      var BLKS_PER_BANK = 4;
      if($.urlParam('BLK') != null) {
        BLKS_PER_BANK = Number($.urlParam('BLK'));
      }
      var PAGES_PER_BLK = 4;
      if($.urlParam('BLK_PAGE') != null) {
        PAGES_PER_BLK = Number($.urlParam('BLK_PAGE'));
      }
      var PAGES_PER_BANK = BLKS_PER_BANK * PAGES_PER_BLK;
      var LPNS_PER_PAGE = 3;
      var LPNS = (PAGES_PER_BLK) * (BLKS_PER_BANK - 1) - 1;
      var PMT_numofRAW = 0;
      var OPERATION_numofRAW = 0;
      var OPERATION_ROWS = 5;
      var OPERATION_CNT = 0;
      var numofPAGE = 0;
      var numofBLK = 1;
      var delay = 1500; 
      var timeld = null;

      $("#blk_inc").click(function() {
        if(BLKS_PER_BANK >= 4) {
          alert("MAX BLK NUM");
          return;
        }
        var url = "./sector_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK) + 1) + "&BLK_PAGE=" + (PAGES_PER_BLK);
        $(location).attr('href', url);
      });
      $("#blk_dec").click(function() {
        if(BLKS_PER_BANK <= 2) {
          alert("MIN BLK NUM");
          return;
        }
        var url = "./sector_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK) - 1) + "&BLK_PAGE=" + (PAGES_PER_BLK);
        $(location).attr('href', url);
      });
      $("#page_per_blk_inc").click(function() {
        if(PAGES_PER_BLK >= 5) {
          alert("MAX PAGE NUM");
          return;
        }
        var url = "./sector_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK)) + "&BLK_PAGE=" + (Number(PAGES_PER_BLK) +1);
        $(location).attr('href', url);
      });
       $("#page_per_blk_dec").click(function() {
        if(PAGES_PER_BLK <= 2) {
          alert("MIN PAGE NUM");
          return;
        }
        var url = "./sector_based_ftl.html?BLK=" + (Number(BLKS_PER_BANK)) + "&BLK_PAGE=" + (Number(PAGES_PER_BLK) - 1);
        $(location).attr('href', url);
      });

      $('#cancle').click(function() {
        cancle_func();
      });

      $('#delay').html(delay);

      $('#delay_down').click(function() {
        if(delay <= 0) {
          alert("delay can't be under 0");
          return;
        }
        delay -= 100;
        $('#delay').html(delay);
      });

      $('#delay_up').click(function() {
        if(delay >= 3000) {
          alert("delay can't be over 3000");
          return;
        }
        delay += 100;
        $('#delay').html(delay);
      });


      $("#step_back").click( function() {
        step_back_func();
      });
      $("#step_foward").click( function() {
        step_foward_func();
      });

      $("#Write").click( function() {
        var LPN_val = $("#LPN_input").val();
        var DATA_val = $("#DATA_input").val();
        if(LPN_val >= LPNS) {
          alert("Wrong LPN number! (LPN range: 0 ~ " + (LPNS - 1) + ")");
          return;
        }

        $("#LPN_input").val(''); $("#DATA_input").val('');
        $("#play_pause").val('pause').attr('disabled', false);
        $("#Write").attr('disabled', true);
        $("#Read").attr('disabled', true);
        $("#delay_up").attr('disabled', true);
        $("#delay_down").attr('disabled', true);
        $("#step_back").attr('disabled', true);
        $("#step_foward").attr('disabled', true);
        $("#cancle").attr('disabled', true);
        $("#Operate").attr('disabled', true);
        ftl_write(LPN_val, DATA_val, 0);
      });
      $("#Read").click( function() {
        var LPN_val = $("#LPN_input2").val();
        if(LPN_val >= LPNS) {
          alert("Wrong LPN number! (LPN range: 0 ~ " + (LPNS - 1) + ")");
          return;
        }

        $("#LPN_input2").val('');
        $("#play_pause").val('pause').attr('disabled', false);
        $("#Write").attr('disabled', true);
        $("#Read").attr('disabled', true);
        $("#delay_up").attr('disabled', true);
        $("#delay_down").attr('disabled', true);
        $("#step_back").attr('disabled', true);
        $("#step_foward").attr('disabled', true);
        $("#cancle").attr('disabled', true);
        $("#Operate").attr('disabled', true);
        ftl_read(LPN_val, 0);
      });

      $("#Operate").click( function() {
        var oper = OPERATION_get_OPERATION(0).html();
        var LPN_val = OPERATION_get_LPN(0).html();
        var DATA_val = OPERATION_get_DATA(0).html();
        if(LPN_val >= LPNS) {
          alert("Wrong LPN number! (LPN range: 0 ~ " + (LPNS - 1) + ")");
          return;
        }

        $("#play_pause").val('pause').attr('disabled', false);
        $("#Write").attr('disabled', true);
        $("#Operate").attr('disabled', true);
        $("#Read").attr('disabled', true);
        $("#delay_up").attr('disabled', true);
        $("#delay_down").attr('disabled', true);
        $("#step_back").attr('disabled', true);
        $("#step_foward").attr('disabled', true);
        $("#cancle").attr('disabled', true);

        if(oper == 'WRITE')
          ftl_write(LPN_val, DATA_val, 1);
        if(oper == 'READ')
          ftl_read(LPN_val, 1);
      });

      $("#play_pause").click( function() {
        if(timeld == null) {
          animation_func();
          $("#delay_up").attr('disabled', true);
          $("#delay_down").attr('disabled', true);
          $("#step_back").attr('disabled', true);
          $("#step_foward").attr('disabled', true);

          timeld = setInterval(animation_func, delay);
          $(this).val('pause');
        }
        else {
          clearInterval(timeld);
          $(this).val('play');
          $("#delay_up").attr('disabled', false);
          $("#delay_down").attr('disabled', false);
          $("#step_back").attr('disabled', false);
          $("#step_foward").attr('disabled', false);
          timeld = null;
        }
      });

      function alloc_step() {
        var now_stat = stat_save_arr[stat_idx];
        now_stat.step_arr[now_stat.step_len] = new Object();
        now_stat.step_len++;
        return now_stat.step_arr[now_stat.step_len - 1];
      }

      function get_pmt_slot(lpn) {
        return parseInt(lpn / LPNS_PER_PAGE);
      }

      function calc_page_offset(lpn) {
        return lpn - (get_pmt_slot(lpn) * LPNS_PER_PAGE);
      }

      function ftl_write(lpn, data, oper) {
        var step_info;
        add_stat();
        if(stat_idx > 0)
          copy_stat(stat_idx, stat_idx - 1);


        if(oper == 1) {
          var step_info = alloc_step();
          step_info.motion = 'operation start';
          step_info.info = 'Operate First Line';
        }

        var now_stat = stat_save_arr[stat_idx];

        if(gc_condition_check() == true) {
          garbage_collection();
          now_stat = stat_save_arr[stat_idx];
        }
        var pmt_slot = get_pmt_slot(lpn);
        var original_page = now_stat.pmt[pmt_slot];
        var new_page = now_stat.page_to_write;
        if(original_page != -1) {
          now_stat.step_arr[now_stat.step_len] = new Object();
          step_info = now_stat.step_arr[now_stat.step_len];
          now_stat.step_len++;
          step_info.motion = "load to ram";
          step_info.info = "Load to RAM"
          step_info.page = original_page;
          step_info.pmt_slot = pmt_slot;
          step_info.data1 = now_stat.page_data1[original_page];
          step_info.data2 = now_stat.page_data2[original_page];
          step_info.data3 = now_stat.page_data3[original_page];



          now_stat.page_stat[original_page] = 'invalid';
          now_stat.step_arr[now_stat.step_len] = new Object();
          step_info = now_stat.step_arr[now_stat.step_len];
          now_stat.step_len++;
          step_info.motion = 'make invalid';
          step_info.info = 'Make Invalid';
          step_info.page = original_page;
        }

        now_stat.page_to_write++;
        now_stat.step_arr[now_stat.step_len] = new Object();
        step_info = now_stat.step_arr[now_stat.step_len];
        now_stat.step_len++;
        step_info.motion = 'change pmt';
        step_info.info = 'Change PMT Page';
        step_info.pmt_slot = pmt_slot;
        step_info.original_ppn = now_stat.pmt[pmt_slot];
        now_stat.pmt[pmt_slot] = new_page;
        step_info.new_ppn = new_page;

        if(original_page != -1) {
          now_stat.page_data1[new_page] = now_stat.page_data1[original_page];
          now_stat.page_data2[new_page] = now_stat.page_data2[original_page];
          now_stat.page_data3[new_page] = now_stat.page_data3[original_page];
        }

        var offset = calc_page_offset(lpn);
        if(offset == 0) {
          now_stat.page_data1[new_page] = data;
        } else if(offset == 1) {
          now_stat.page_data2[new_page] = data;
        } else {
          now_stat.page_data3[new_page] = data;
        }
        now_stat.page_stat[new_page] = 'valid';
        now_stat.page_spare[new_page] = pmt_slot;

        if(original_page != -1) {
           now_stat.step_arr[now_stat.step_len] = new Object();
            step_info = now_stat.step_arr[now_stat.step_len];
            now_stat.step_len++;
            step_info.motion = 'write ram';
            step_info.info = 'Write New Data';
            step_info.page = new_page;
            step_info.data1 = now_stat.page_data1[new_page];
            step_info.data2 = now_stat.page_data2[new_page];
            step_info.data3 = now_stat.page_data3[new_page];
            step_info.stat = 'valid';
            step_info.pmt_slot = pmt_slot;
          }

        now_stat.step_arr[now_stat.step_len] = new Object();
        step_info = now_stat.step_arr[now_stat.step_len];
        now_stat.step_len++;
        step_info.motion = 'write page';
        step_info.info = 'Write Page';
        step_info.page = new_page;
        step_info.data1 = now_stat.page_data1[new_page];
        step_info.data2 = now_stat.page_data2[new_page];
        step_info.data3 = now_stat.page_data3[new_page];
        if(original_page != -1)
          step_info.ram_write = 1;
        else
          step_info.ram_write = 0;
        console.log("step_info.data1: " + step_info.data1);
        console.log("step_info.data2: " + step_info.data2);
        console.log("step_info.data3: " + step_info.data3);
        step_info.stat = 'valid';
        step_info.pmt_slot = pmt_slot;
        console.log("pmt_slot: " + pmt_slot);

        // now_stat.page_data[new_page] = data;
        // now_stat.step_arr[now_stat.step_len] = new Object();
        // step_info = now_stat.step_arr[now_stat.step_len];
        // now_stat.step_len++;
        // step_info.motion = 'write data';
        // step_info.page = new_page;
        // step_info.data = now_stat.page_data[new_page];

        // now_stat.page_stat[new_page] = 'valid';
        // now_stat.step_arr[now_stat.step_len] = new Object();
        // step_info = now_stat.step_arr[now_stat.step_len];
        // now_stat.step_len++;
        // step_info.motion = 'make valid';
        // step_info.page = new_page;

        // now_stat.page_spare[new_page] = lpn;
        // now_stat.step_arr[now_stat.step_len] = new Object();
        // step_info = now_stat.step_arr[now_stat.step_len];
        // now_stat.step_len++;
        // step_info.motion = 'write spare';
        // step_info.page = new_page;
        // step_info.lpn = lpn;

         if(oper == 1) {
          step_info = alloc_step();
          step_info.motion = 'operation finish';
          step_info.info = 'Delete First Line';
        }

        animation_func();
        timeld = setInterval(animation_func, delay);
      }

      function ftl_read(lpn, oper) {
        var step_info;
        add_stat();
        if(stat_idx > 0)
          copy_stat(stat_idx, stat_idx - 1);


        if(oper == 1) {
          var step_info = alloc_step();
          step_info.motion = 'operation start';
          step_info.info = 'Operate First Line';
        }

        var now_stat = stat_save_arr[stat_idx];
        var pmt_slot = get_pmt_slot(lpn);
        var original_page = now_stat.pmt[pmt_slot];

        now_stat.step_arr[now_stat.step_len] = new Object();
        step_info = now_stat.step_arr[now_stat.step_len];
        now_stat.step_len++;
        step_info.motion = 'change pmt';
        step_info.info = 'Check PMT';
        step_info.pmt_slot = pmt_slot;
        step_info.original_ppn = now_stat.pmt[pmt_slot];
        step_info.new_ppn = now_stat.pmt[pmt_slot];
        if(now_stat.pmt[pmt_slot] == -1) {
          step_info.new_ppn = 'none';
          step_info.info += ': none';
        }

        
        if(original_page != -1) {
          now_stat.step_arr[now_stat.step_len] = new Object();
          step_info = now_stat.step_arr[now_stat.step_len];
          now_stat.step_len++;
          step_info.motion = "load to ram";
          step_info.info = "Load to RAM"
          step_info.page = original_page;
          step_info.pmt_slot = pmt_slot;
          step_info.data1 = now_stat.page_data1[original_page];
          step_info.data2 = now_stat.page_data2[original_page];
          step_info.data3 = now_stat.page_data3[original_page];
        }

        var offset = calc_page_offset(lpn);

        if(original_page != -1) {
           now_stat.step_arr[now_stat.step_len] = new Object();
            step_info = now_stat.step_arr[now_stat.step_len];
            now_stat.step_len++;
            step_info.motion = 'write ram';
            step_info.read_operation = true;
            step_info.info = 'Read Data';
            step_info.page = original_page;
            step_info.data1 = now_stat.page_data1[original_page];
            step_info.data2 = now_stat.page_data2[original_page];
            step_info.data3 = now_stat.page_data3[original_page];
            var temp_data;
            if(offset == 0) {
              temp_data = now_stat.page_data1[original_page];
            } else if(offset == 1) {
              temp_data = now_stat.page_data2[original_page];
            } else {
              temp_data = now_stat.page_data3[original_page];
            }
            if(temp_data == -1)
              step_info.info += ': none';
            else
              step_info.info += ': ' + temp_data;
            step_info.stat = 'valid';
            step_info.pmt_slot = pmt_slot;
          }

         if(oper == 1) {
          step_info = alloc_step();
          step_info.motion = 'operation finish';
          step_info.info = 'Delete First Line';
        }

        animation_func();
        timeld = setInterval(animation_func, delay);
      }

     

      function cancle_func() {
        if(stat_idx == -1) {
          alert("initial state!");
          return;
        }
        $("#PMT").remove();
        $("#RAM").remove();
        for(var i = 0; i < numofBLK; i++) {
          $("#BLK" + i).remove();
        }
        $("#OPERATION").remove();
        OPERATION_CNT -= 1;
        // stat_save_arr[stat_idx].step_idx = stat_save_arr[stat_idx].step_idx - 1;
        var step_info = stat_save_arr[stat_idx].step_arr[0]; // state of right before
        stat_idx -= 1;
        step_info.PMT_elem.appendTo("#body");
        step_info.RAM_elem.appendTo("#body");
        step_info.OPERATION_elem.appendTo("#body");
        if(step_info.file_opened == 1) {
          $("#Operate").css("display", "block");
          console.log("cancle_func OPERATION_ROWS: " + step_info.OPERATION_ROWS);
          OPERATION_ROWS = step_info.OPERATION_ROWS;
        } else {
          $("#Operate").css("display", "none");
        }
        for(var i = 0; i < numofBLK; i++)
          step_info.BLK_elem_arr[i].appendTo("#body");
      }

      function step_back_func() {
        if(stat_save_arr[stat_idx].step_idx == 0) {
          alert("initial state!");
          return;
        }
        $("#PMT").remove();
        $("#RAM").remove();
        $("#OPERATION").remove();
        for(var i = 0; i < numofBLK; i++) {
          $("#BLK" + i).remove();
        }
        stat_save_arr[stat_idx].step_idx = stat_save_arr[stat_idx].step_idx - 1;
        var step_info = stat_save_arr[stat_idx].step_arr[stat_save_arr[stat_idx].step_idx];
        step_info.PMT_elem.appendTo("#body");
        step_info.RAM_elem.appendTo("#body");
        step_info.OPERATION_elem.appendTo("#body");
        for(var i = 0; i < numofBLK; i++)
          step_info.BLK_elem_arr[i].appendTo("#body");
      }
      function step_foward_func() {
        if(stat_save_arr[stat_idx].step_idx == stat_save_arr[stat_idx].step_len) {
          alert("last state!")
          return;
        }
        animation_func();
      }

      function save_step_stat(step_info) {
        step_info.PMT_elem = $("#PMT").clone();
        step_info.RAM_elem = $("#RAM").clone();
        step_info.OPERATION_elem = $("#OPERATION").clone();
        step_info.BLK_elem_arr = new Array();
        for(var i = 0; i < numofBLK; i++) {
          step_info.BLK_elem_arr[i] = $("#BLK" + i).clone();
        }
      }

      function animation_func() {
        if(stat_save_arr[stat_idx].step_idx >= stat_save_arr[stat_idx].step_len) {
          clearInterval(timeld);
          timeld = null;

          $("#play_pause").val('play').attr('disabled', true);
          $("#Write").attr('disabled', false);
          $("#Operate").attr('disabled', false);
          $("#Read").attr('disabled', false);
          $("#delay_up").attr('disabled', false);
          $("#delay_down").attr('disabled', false);
          $("#step_back").attr('disabled', false);
          $("#step_foward").attr('disabled', false);
          $("#cancle").attr('disabled', false);
          return;
        }
        console.log("step_idx: " + stat_save_arr[stat_idx].step_idx);

        var step_info = stat_save_arr[stat_idx].step_arr[stat_save_arr[stat_idx].step_idx];
        stat_save_arr[stat_idx].step_idx++;

        console.log("motion: " + step_info.motion);
        $('body').append('<span id = "info">' + step_info.info + '</span>');
        setTimeout(function() {
          $("#info").remove();
        }, delay);
        if(step_info.motion == 'make invalid') {
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_STATE(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_DATA1(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_DATA2(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_DATA3(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_LPN(step_info.page).removeClass('valid').addClass('focus');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page).removeClass('focus').addClass('invalid');
            BLK_get_STATE(step_info.page).removeClass('focus').addClass('invalid').html('invalid');
            BLK_get_DATA1(step_info.page).removeClass('focus').addClass('invalid');
            BLK_get_DATA2(step_info.page).removeClass('focus').addClass('invalid');
            BLK_get_DATA3(step_info.page).removeClass('focus').addClass('invalid');
            BLK_get_LPN(step_info.page).removeClass('focus').addClass('invalid');
          }, delay / 2);
        } else if(step_info.motion == 'make empty'){
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_STATE(step_info.page).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_DATA1(step_info.page).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_DATA2(step_info.page).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_DATA3(step_info.page).removeClass('invalid').removeClass('valid').addClass('focus');
          BLK_get_LPN(step_info.page).removeClass('invalid').removeClass('valid').addClass('focus');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page).removeClass('focus');
            BLK_get_STATE(step_info.page).removeClass('focus').html('empty');
            BLK_get_DATA1(step_info.page).removeClass('focus').html('');
            BLK_get_DATA2(step_info.page).removeClass('focus').html('');
            BLK_get_DATA3(step_info.page).removeClass('focus').html('');
            BLK_get_LPN(step_info.page).removeClass('focus').html('');
          }, delay / 2);
        } else if(step_info.motion == 'copy page') {
          save_step_stat(step_info);
          BLK_get_STATE(step_info.page).addClass('focus');
          BLK_get_DATA1(step_info.page).addClass('focus');
          BLK_get_DATA2(step_info.page).addClass('focus');
          BLK_get_DATA3(step_info.page).addClass('focus');
          BLK_get_LPN(step_info.page).addClass('focus');
          setTimeout(function() {
            BLK_get_STATE(step_info.page).removeClass('focus').html( step_info.stat );
            BLK_get_DATA1(step_info.page).removeClass('focus').html(step_info.data1);
            BLK_get_DATA2(step_info.page).removeClass('focus').html(step_info.data2);
            BLK_get_DATA3(step_info.page).removeClass('focus').html(step_info.data3);
            BLK_get_LPN(step_info.page).removeClass('focus').html(step_info.spare);
          }, delay / 2);
        } else if(step_info.motion == 'change pmt') {
          save_step_stat(step_info);
          PMT_get_PPN(step_info.pmt_slot).addClass('focus');
          setTimeout(function() {
            PMT_get_PPN(step_info.pmt_slot).removeClass('focus').html(step_info.new_ppn);
          }, delay / 2);
        } else if(step_info.motion == 'write data') {
          save_step_stat(step_info);
          BLK_get_DATA1(step_info.page).addClass('focus');
          BLK_get_DATA2(step_info.page).addClass('focus');
          BLK_get_DATA3(step_info.page).addClass('focus');
          setTimeout(function() {
            BLK_get_DATA1(step_info.page).removeClass('focus').html(step_info.data1);
            BLK_get_DATA2(step_info.page).removeClass('focus').html(step_info.data2);
            BLK_get_DATA3(step_info.page).removeClass('focus').html(step_info.data3);
          }, delay / 2);
        } else if(step_info.motion == 'make valid') {
          save_step_stat(step_info);
          BLK_get_STATE(step_info.page).addClass('focus');
          setTimeout(function() {
            BLK_get_STATE(step_info.page).removeClass('focus').html('valid');
          }, delay / 2);
        } else if(step_info.motion == 'write spare') {
          save_step_stat(step_info);
          BLK_get_LPN(step_info.page).addClass('focus');
          // data_movement2(PMT_get_LPN(step_info.lpn), BLK_get_LPN(step_info.page))
          setTimeout(function() {
            BLK_get_LPN(step_info.page).removeClass('focus').html(step_info.lpn);
          }, delay / 2);
        } else if(step_info.motion == 'operation start') {
          step_info.file_opened = true;
          step_info.OPERATION_ROWS = OPERATION_ROWS;
          save_step_stat(step_info);
          OPERATION_get_NUM(0).addClass('focus');
          OPERATION_get_OPERATION(0).addClass('focus');
          OPERATION_get_LPN(0).addClass('focus');
          OPERATION_get_DATA(0).addClass('focus');
        } else if(step_info.motion == 'operation finish') {
          step_info.file_opened = false;
          step_info.OPERATION_ROWS = OPERATION_ROWS;
          save_step_stat(step_info);
          $("#OPERATION").addClass('focus');
          // for(var i = 1; i < OPERATION_ROWS; i++) {
          //   OPERATION_get_OPERATION(i).addClass('focus');
          //   OPERATION_get_LPN(i).addClass('focus');
          //   OPERATION_get_DATA(i).addClass('focus');
          // }
          setTimeout(function() {
            $("#OPERATION").removeClass('focus');
            OPERATION_get_NUM(0).removeClass('focus');
            OPERATION_get_OPERATION(0).removeClass('focus');
            OPERATION_get_LPN(0).removeClass('focus');
            OPERATION_get_DATA(0).removeClass('focus');
            for(var i = 0; i < OPERATION_ROWS; i++) {
              // OPERATION_get_OPERATION(i).removeClass('focus');
              // OPERATION_get_LPN(i).removeClass('focus');
              // OPERATION_get_DATA(i).removeClass('focus');
              if(i != 0) {
                var op = OPERATION_get_OPERATION(i).html();
                var lpn = OPERATION_get_LPN(i).html();
                var data = OPERATION_get_DATA(i).html();
                OPERATION_get_OPERATION(i - 1).html(op);
                OPERATION_get_LPN(i - 1).html(lpn);
                OPERATION_get_DATA(i - 1).html(data);
              }
              if(i == OPERATION_ROWS - 1) {
                OPERATION_get_OPERATION(i).html('');
                OPERATION_get_LPN(i).html('');
                OPERATION_get_DATA(i).html('');
              }
            }
          }, delay / 2);
          OPERATION_CNT += 1;
          if(OPERATION_CNT == OPERATION_ROWS) {
            $("#OPERATION").css("display", "none");
            $("#Operate").css("display", "none");
          }
        } else if(step_info.motion == 'write page') {
          // step_info.page = new_page;
          // step_info.data = now_stat.page_data[new_page];
          // step_info.stat = 'valid';
          // step_info.lpn = lpn;
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page).addClass('focus');
          BLK_get_DATA1(step_info.page).addClass('focus');
          BLK_get_DATA2(step_info.page).addClass('focus');
          BLK_get_DATA3(step_info.page).addClass('focus');
          BLK_get_STATE(step_info.page).addClass('focus');
          BLK_get_LPN(step_info.page).addClass('focus');
          if(step_info.ram_write == 1) {
            RAM_get_PPN().addClass('focus');
            RAM_get_DATA1().addClass('focus');
            RAM_get_DATA2().addClass('focus');
            RAM_get_DATA3().addClass('focus');
            RAM_get_LPN().addClass('focus');
          }

          setTimeout(function() {
            BLK_get_PPN_data(step_info.page).removeClass('focus').addClass('valid');
            BLK_get_DATA1(step_info.page).removeClass('focus').addClass('valid').html(step_info.data1);
            BLK_get_DATA2(step_info.page).removeClass('focus').addClass('valid').html(step_info.data2);
            BLK_get_DATA3(step_info.page).removeClass('focus').addClass('valid').html(step_info.data3);
            // BLK_get_LPN(step_info.page).removeClass('focus').addClass('valid').html(step_info.pmt_slot * LPNS_PER_PAGE + ' - ' +  step_info.pmt_slot * LPNS_PER_PAGE + LPNS_PER_PAGE - 1);
            BLK_get_LPN(step_info.page).removeClass('focus').addClass('valid').html( (step_info.pmt_slot * LPNS_PER_PAGE) + ' - ' +  (step_info.pmt_slot * LPNS_PER_PAGE + LPNS_PER_PAGE - 1));
            BLK_get_STATE(step_info.page).removeClass('focus').addClass('valid').html('valid');

            if(step_info.ram_write == 1) {
              RAM_get_PPN().removeClass('focus').html('none');
              RAM_get_DATA1().removeClass('focus').html('');
              RAM_get_DATA2().removeClass('focus').html('');
              RAM_get_DATA3().removeClass('focus').html('');
              RAM_get_LPN().removeClass('focus').html('');
            }

          }, delay / 2);
        } else if(step_info.motion == 'load to ram') {
          save_step_stat(step_info);
          BLK_get_PPN_data(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_STATE(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_DATA1(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_DATA2(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_DATA3(step_info.page).removeClass('valid').addClass('focus');
          BLK_get_LPN(step_info.page).removeClass('valid').addClass('focus');
          RAM_get_PPN().addClass('focus');
          RAM_get_DATA1().addClass('focus');
          RAM_get_DATA2().addClass('focus');
          RAM_get_DATA3().addClass('focus');
          RAM_get_LPN().addClass('focus');
          setTimeout(function() {
            BLK_get_PPN_data(step_info.page).removeClass('focus').addClass('valid');
            BLK_get_STATE(step_info.page).removeClass('focus').addClass('valid');
            BLK_get_DATA1(step_info.page).removeClass('focus').addClass('valid');
            BLK_get_DATA2(step_info.page).removeClass('focus').addClass('valid');
            BLK_get_DATA3(step_info.page).removeClass('focus').addClass('valid');
            BLK_get_LPN(step_info.page).removeClass('focus').addClass('valid');
            RAM_get_PPN().removeClass('focus').html(step_info.page);
            RAM_get_DATA1().removeClass('focus').html(step_info.data1);
            RAM_get_DATA2().removeClass('focus').html(step_info.data2);
            RAM_get_DATA3().removeClass('focus').html(step_info.data3);
            RAM_get_LPN().removeClass('focus').html((step_info.pmt_slot * LPNS_PER_PAGE) + ' - ' + (step_info.pmt_slot * LPNS_PER_PAGE + LPNS_PER_PAGE - 1) );
          }, delay / 2);
        } else if(step_info.motion == 'write ram') {
          save_step_stat(step_info);
          RAM_get_PPN().addClass('focus');
          RAM_get_DATA1().addClass('focus');
          RAM_get_DATA2().addClass('focus');
          RAM_get_DATA3().addClass('focus');
          RAM_get_LPN().addClass('focus');
          setTimeout(function() {
            RAM_get_PPN().removeClass('focus');
            RAM_get_DATA1().removeClass('focus').html(step_info.data1);
            RAM_get_DATA2().removeClass('focus').html(step_info.data2);
            RAM_get_DATA3().removeClass('focus').html(step_info.data3);
            RAM_get_LPN().removeClass('focus').html( (step_info.pmt_slot * LPNS_PER_PAGE) + ' - ' +  (step_info.pmt_slot * LPNS_PER_PAGE + LPNS_PER_PAGE - 1));
            if(step_info.read_operation == true) {
              RAM_get_PPN().removeClass('focus').html('none');
              RAM_get_DATA1().removeClass('focus').html('');
              RAM_get_DATA2().removeClass('focus').html('');
              RAM_get_DATA3().removeClass('focus').html('');
              RAM_get_LPN().removeClass('focus').html('');
            }
          }, delay / 2);
        } 
        else {
          console.log("No motion info!");
        }
      }
      function gc_condition_check() {
        var page_num = stat_save_arr[stat_idx].page_to_write;
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var free_blk_idx = stat_save_arr[stat_idx].free_blk_idx;


        console.log("<gc_condition_check function>");
        console.log("page number: " + page_num);
        console.log("blk number: " + blk_num);
        console.log("state of page to write: " + BLK_get_STATE(page_num).html());
        console.log("free_blk_idx: " + free_blk_idx);
        if(page_num >= PAGES_PER_BANK || blk_num == free_blk_idx || BLK_get_STATE(page_num).html() != 'empty')
          return true;
        return false;
      }

      function garbage_collection() {
        console.log("<garbage_collection function called>");

        //find victim block
        var blk_invalid_cnt = new Array();
        for(var i = 0; i < BLKS_PER_BANK; i++) {
          blk_invalid_cnt[i] = 0;
        }
        for(var i = 0; i < PAGES_PER_BANK; i++) {
          var blk_num = parseInt(i / PAGES_PER_BLK);
          if(stat_save_arr[stat_idx].page_stat[i] == 'invalid') {
            blk_invalid_cnt[blk_num] += 1;
          }
        }

        for(var i = 0; i < BLKS_PER_BANK; i++) {
          console.log("blk:" + i + " invalid: " + blk_invalid_cnt[i]);
        }
        var victim_blk = 0;
        var invalid_cnt = -1;
        for(var i = 0; i < BLKS_PER_BANK; i++) {
          if(invalid_cnt < blk_invalid_cnt[i]) {
            victim_blk = i;
            invalid_cnt = blk_invalid_cnt[i];
          }
        }
        console.log("selected victim block: " + victim_blk);

        //move valid pages to free blk
        var victim_start_page = victim_blk * PAGES_PER_BLK;
        var free_start_page = stat_save_arr[stat_idx].free_blk_idx * PAGES_PER_BLK;
        var valid_cnt = 0;
        var now_stat = stat_save_arr[stat_idx];

        for(var i = 0; i < PAGES_PER_BLK; i++) {
          var victim_page = victim_start_page + i;

          now_stat.step_arr[now_stat.step_len] = new Object();
          var step_info = now_stat.step_arr[now_stat.step_len];
          now_stat.step_len++;
          step_info.motion = 'make empty';
          step_info.info = 'Empty Page';
          step_info.page = victim_page;          

          if(BLK_get_STATE(victim_start_page + i).html() == 'valid') {
            var free_page = free_start_page + valid_cnt;
           
            stat_save_arr[stat_idx].page_stat[free_page] = stat_save_arr[stat_idx].page_stat[victim_page];
            stat_save_arr[stat_idx].page_data1[free_page] = stat_save_arr[stat_idx].page_data1[victim_page];
            stat_save_arr[stat_idx].page_data2[free_page] = stat_save_arr[stat_idx].page_data2[victim_page];
            stat_save_arr[stat_idx].page_data3[free_page] = stat_save_arr[stat_idx].page_data3[victim_page];
            stat_save_arr[stat_idx].page_spare[free_page] = stat_save_arr[stat_idx].page_spare[victim_page];

            now_stat.step_arr[now_stat.step_len] = new Object();
            var step_info = now_stat.step_arr[now_stat.step_len];
            now_stat.step_len++;
            step_info.motion = 'write page';
            step_info.info = 'Write Page';
            step_info.page = free_page;
            step_info.stat = stat_save_arr[stat_idx].page_stat[free_page];
            step_info.data1 = stat_save_arr[stat_idx].page_data1[free_page];
            step_info.data2 = stat_save_arr[stat_idx].page_data2[free_page];
            step_info.data3 = stat_save_arr[stat_idx].page_data3[free_page];
            step_info.pmt_slot = stat_save_arr[stat_idx].page_spare[free_page];

            now_stat.step_arr[now_stat.step_len] = new Object();
            step_info = now_stat.step_arr[now_stat.step_len];
            var pmt_slot = stat_save_arr[stat_idx].page_spare[victim_page];
            now_stat.step_len++;
            step_info.motion = 'change pmt';
            step_info.info = 'Change PMT Page';
            step_info.pmt_slot = pmt_slot;
            now_stat.pmt[pmt_slot] = free_page;
            step_info.new_ppn = free_page;

            valid_cnt++;
          } 

          stat_save_arr[stat_idx].page_stat[victim_page] = 'empty';
          stat_save_arr[stat_idx].page_data1[victim_page] = '';
          stat_save_arr[stat_idx].page_data2[victim_page] = '';
          stat_save_arr[stat_idx].page_data3[victim_page] = '';
          stat_save_arr[stat_idx].page_spare[victim_page] = '';
        }
        stat_save_arr[stat_idx].page_to_write = free_start_page + valid_cnt;
        stat_save_arr[stat_idx].free_blk_idx = victim_blk;
      }

      function add_stat() {
        stat_idx++;
        stat_save_arr[stat_idx] = new Object();
        stat_save_arr[stat_idx].pmt = new Array();
        stat_save_arr[stat_idx].page_stat = new Array();
        stat_save_arr[stat_idx].page_data1 = new Array();
        stat_save_arr[stat_idx].page_data2 = new Array();
        stat_save_arr[stat_idx].page_data3 = new Array();
        stat_save_arr[stat_idx].page_spare = new Array();
        stat_save_arr[stat_idx].page_to_write = 0;

        stat_save_arr[stat_idx].free_blk_idx = BLKS_PER_BANK - 1;
        if(stat_idx > 1) {
          stat_save_arr[stat_idx].free_blk_idx = stat_save_arr[stat_idx - 1].free_blk_idx;
        }


        for(var i = 0; i < PAGES_PER_BANK; i++) {
          stat_save_arr[stat_idx].pmt[i] = -1;
          stat_save_arr[stat_idx].page_stat[i] = 'empty';
          stat_save_arr[stat_idx].page_data1[i] = 'none';
          stat_save_arr[stat_idx].page_data2[i] = 'none';
          stat_save_arr[stat_idx].page_data3[i] = 'none';
          stat_save_arr[stat_idx].page_spare[i] = -1;
        }

        stat_save_arr[stat_idx].step_len = 0;
        stat_save_arr[stat_idx].step_arr = new Array();
        stat_save_arr[stat_idx].step_idx = 0;
      }

      function copy_stat(des, src) {
        // if(stat_idx <= 1) return;
        stat_save_arr[des].page_to_write = stat_save_arr[src].page_to_write;
        stat_save_arr[des].free_blk_idx = stat_save_arr[src].free_blk_idx;
        for(var i = 0; i < PAGES_PER_BANK; i++) {
          stat_save_arr[des].pmt[i] = stat_save_arr[src].pmt[i];
          stat_save_arr[des].page_stat[i] = stat_save_arr[src].page_stat[i];
          stat_save_arr[des].page_data1[i] = stat_save_arr[src].page_data1[i];
          stat_save_arr[des].page_data2[i] = stat_save_arr[src].page_data2[i];
          stat_save_arr[des].page_data3[i] = stat_save_arr[src].page_data3[i];
          stat_save_arr[des].page_spare[i] = stat_save_arr[src].page_spare[i];
        }
      }
      for(var i = 0; i < LPNS; i++)
        PMT_add_row();
      for(var i = 0; i < PAGES_PER_BLK; i++)
        BLK_add_row(0);
      for(var i = 0; i < BLKS_PER_BANK - 1; i++)
        BLK_increase();

      //RAM_add_row
      $("#RAM").append('<tr id = "ram_row"><tr>');
      for(var i = 0; i < 5; i++) {
        if(i == 0) {
          $("#ram_row").append('<td style="border-left: 2px solid #CCC;">none</td>');
        }
        else if (i == 4) {
          $("#ram_row").append('<td style="border-right: 2px solid #CCC;"></td>');
        }
        else {
          $("#ram_row").append('<td></td>');
        }
      }
      $("#ram_row").css("border-bottom", "2px solid #CCC");


      // for(var i = 0; i < BLKS_PER_BANK * PAGES_PER_BLK; i++) {
      //   BLK_get_PPN_data(i).addClass('background_color1');
      //   BLK_get_DATA(i).addClass('background_color1');
      //   BLK_get_LPN(i).addClass('background_color1');
      //   BLK_get_STATE(i).addClass('background_color1');
      // }

      function PMT_add_row() {
        $("#PMT").append('<tr id = "PMT_row' + PMT_numofRAW +  '"><tr>');
        for(var i = 0; i < 2; i++) {
          if(i == 0)
            $("#PMT_row"+PMT_numofRAW).append('<td style="border-left: 2px solid #CCC;">' + (PMT_numofRAW * LPNS_PER_PAGE) + ' - ' + (PMT_numofRAW*LPNS_PER_PAGE + LPNS_PER_PAGE - 1) + '</td>');
          else
            $("#PMT_row"+PMT_numofRAW).append('<td style="border-right: 2px solid #CCC;">none</td>');
        }
        $("#PMT_row" + PMT_numofRAW).css("border-bottom", "1px solid #CCC");
        if(PMT_numofRAW == LPNS - 1) {
          $("#PMT_row" + PMT_numofRAW).css("border-bottom", "2px solid #CCC").css("border-bottom-left-radius", "5px");
        }
        PMT_numofRAW++;
      }
      function OPERATION_add_row() {
        $("#OPERATION").append('<tr id = "OPERATION_row' + OPERATION_numofRAW +  '"><tr>');
        for(var i = 0; i < 4; i++) {
          if(i == 0)
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td style="border-left: 2px solid #CCC;">' + (OPERATION_numofRAW + 1) + '</td>');
          else if(i == 1)
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td></td>');
          else if(i == 3)
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td style="border-right: 2px solid #CCC;"></td>');
          else
            $("#OPERATION_row"+OPERATION_numofRAW).append('<td></td>');
        }
        if(OPERATION_numofRAW == OPERATION_ROWS - 1) 
          $("#OPERATION_row"+OPERATION_numofRAW).css("border-bottom", "2px solid #CCC");
        else
          $("#OPERATION_row"+OPERATION_numofRAW).css("border-bottom", "1px solid #CCC");

        OPERATION_numofRAW++;
      }
      function BLK_add_row(blk_idx) {
        $("#BLK" + blk_idx).append('<tr id = "page_row' + numofPAGE +  '"><tr>');
        for(var i = 0; i < 6; i++) {
          if(i == 0) {
            $("#page_row"+numofPAGE).append('<td style="border-left: 2px solid #CCC;">' + numofPAGE + '</td>');
          }
          else if (i == 5) {
            $("#page_row"+numofPAGE).append('<td style="border-right: 2px solid #CCC;">empty</td>');
          }
          else {
            $("#page_row"+numofPAGE).append('<td></td>');
          }
        }
        $("#page_row"+numofPAGE).css("border-bottom", "1px solid #CCC");
        if(numofPAGE == PAGES_PER_BLK - 1) {
          $("#page_row"+numofPAGE).css("border-bottom", "2px solid #CCC");
        }
        numofPAGE++;
      }
      function BLK_increase() {
        var origin = "#BLK" + (numofBLK - 1);
        var temp = $(origin).clone();

        if(numofBLK >= 2) {
         var side = "#BLK" + (numofBLK - 2);
         temp.appendTo("#body").offset({left: $(side).offset().left + 450, top: $(side).offset().top});
        } else {
          temp.appendTo("#body").offset({left: $(origin).offset().left, top: $(origin).offset().top + 180});
        }

        temp.attr("id", "BLK" + (numofBLK));
        temp.attr("class", "BLOCK");

        numofBLK++;
        for(var i = 0; i < PAGES_PER_BLK; i++) {
          BLK_set_PPN_data(numofPAGE, numofPAGE);
          numofPAGE++;
        }
      }

      function BLK_get_PPN_data(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 0 +')');
      }
      function BLK_get_DATA1(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 1 +')');
      }
      function BLK_get_DATA2(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 2 +')');
      }
      function BLK_get_DATA3(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 3 +')');
      }
      function BLK_get_LPN(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 4 +')');
      }
      function BLK_get_STATE(page_num) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        return $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 5 +')');
      }
      function BLK_set_PPN_data(page_num, data) {
        var blk_num = parseInt(page_num / PAGES_PER_BLK);
        var page_offset = page_num % PAGES_PER_BLK;
        $('#BLK' + (blk_num) + ' tr:eq(' + (page_offset*2+1) + ')>td:eq('+ 0 +')').html(data);
      }
      function PMT_get_LPN(slot_idx) {
        return $('#PMT tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 0 +')');
      }
      function PMT_get_PPN(slot_idx) {
        return $('#PMT tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 1 +')');
      }
      function RAM_get_PPN() {
       return $('#RAM tr:eq(' + (1) + ')>td:eq('+ 0 +')'); 
      }
      function RAM_get_DATA1() {
       return $('#RAM tr:eq(' + (1) + ')>td:eq('+ 1 +')'); 
      }
      function RAM_get_DATA2() {
       return $('#RAM tr:eq(' + (1) + ')>td:eq('+ 2 +')'); 
      }
      function RAM_get_DATA3() {
       return $('#RAM tr:eq(' + (1) + ')>td:eq('+ 3 +')'); 
      }
      function RAM_get_LPN() {
       return $('#RAM tr:eq(' + (1) + ')>td:eq('+ 4 +')'); 
      }

      function OPERATION_get_NUM(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 0 +')');
      }
      function OPERATION_get_OPERATION(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 1 +')');
      }
      function OPERATION_get_LPN(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 2 +')');
      }
      function OPERATION_get_DATA(slot_idx) {
        return $('#OPERATION tr:eq(' + (slot_idx*2+1) + ')>td:eq('+ 3 +')');
      }

      // function data_movement2(src, des) {
      //   // console.log($(src).html());
      //   var _clone = src.clone();
      //    $(_clone).appendTo('#body').addClass('test2');
      //    var _clone_left = $(_clone).offset().left;
      //    var _clone_top = $(_clone).offset().top;

      //    $(_clone).offset({top: src.offset().top, left: src.offset().left});
      //    $(_clone).eq(1).offset({left:src.offset().left + $(_clone).eq(0).width()});
      //    $(_clone).eq(2).offset({left:src.offset().left + $(_clone).eq(0).width() * 2});
      //    $(_clone).animate({
      //      top: des.offset().top - 1 - _clone_top,
      //      left: des.offset().left + 7 - _clone_left
      //    }, delay - 500, 'swing');
      //    setTimeout(function() {$(_clone).fadeOut(delay / 10)}, 0);
      //    setTimeout(function() {$(_clone).remove()}, delay + 1000);
      // }
    </script>
  </body>
</html>
